# Depends:
#  pkg-config, gcc-libs (libgcc & libstdc++)
# Optional depends:
#  libtool, qt5, libiconv, zlib, liblzma (xz), expat, libpng, libjpeg (libjpeg-turbo), libtiff,
#  libjbig, libxpm, libmspack, SDL2, cairo, libsecret, webkit, xtst, libnotify, gnomevfs,
#  gtkprint, gst, mesagl, glu, gl, sm, directfb, pangoxft, pangoft2, Xinerama, Xxf86vm, xmkmf
#
# TODO: use CMake to build
#
# Notes:
#  - libtool required for autoreconf command
#  - DLLs are installed to lib dir

# Bugs to report:
#  - GNU Autotools build:
#    - '--disable/enable-metafiles' does not work
#    - wxrc-<ver> executable not suffixed with .exe on Windows

if ${os_win}; then
	depends=(expat libiconv-reb freetype-reb cairo-reb)
else
	depends=(pkg-config)
fi

ver="3.1.2"
ver_base="${ver%.*}"
dname="${name}-${ver}"
fname="${dname}.tar.bz2"
src="https://github.com/wxWidgets/wxWidgets/releases/download/v${ver}/${fname}"

#cmd_config=(cmake)

gnu_opts=(
	--disable-apple_ieee
	--disable-debugreport
	--disable-dialupman
	# audio
	--disable-sound
	# user input
	--disable-joystick
	--disable-mousewheel
	# libraries/dependencies
	--disable-gtktest
	--disable-sdltest
	--with-libpng=sys
	--without-libjpeg
	--without-libtiff
	--with-zlib=sys
	--without-liblzma
	--with-expat=sys
)

cmake_opts=(
	# no options for GTK & SDL tests???
	-DwxBUILD_COMPATIBILITY=3.0
	-DwxUSE_APPLE_IEEE=OFF
	-DwxUSE_DEBUGREPORT=OFF
	-DwxUSE_DIALUP_MANAGER=OFF
	# audio
	-DwxUSE_SOUND=OFF
	# user input
	-DwxUSE_JOYSTICK=OFF
	-DwxUSE_MOUSEWHEEL=OFF
	# libraries/dependencies
	-DwxUSE_LIBPNG=sys
	-DwxUSE_LIBJPEG=OFF
	-DwxUSE_LIBTIFF=OFF
	-DwxUSE_ZLIB=sys
	-DwxUSE_LIBLZMA=OFF
	-DwxUSE_EXPAT=sys
)

use_cmake=false
if test "${cmd_config[0]}" == "cmake"; then
	use_cmake=true
fi

if ! ${use_cmake}; then
	# using GNU autotools
	config_opts=(${gnu_opts[@]})

	if ${os_win}; then
		config_opts+=(
			--with-msw
			--disable-dbghelp
			--disable-iniconf
			--disable-mshtmlhelp
			--disable-ownerdrawn
			--disable-wxdib
			# types support
			--disable-xpm
			--enable-ico_cur
			# libraries/dependencies
			--without-libxpm
			--with-libiconv=builtin
			--with-regex=builtin
			--with-liblzma=builtin
		)
		libtype_opts=(
			--enable-shared=yes
			--enable-monolithic
		)
		ldflags+=(-static-libgcc -static-libstdc++)

		# wxrc-<ver> executable not suffixed with .exe
		post_install() {
			mv -v "${install_prefix}/bin/wxrc-${ver_base}" "${install_prefix}/bin/wxrc-${ver_base}.exe"
		}
	else
		config_opts+=(
			--disable-mdi # getting linker errors on Linux/Gtk: undefined reference to `vtable for wxMDIClientWindow'
			--disable-detect_sm
			--disable-dynlib
			# types support
			--enable-xpm
			--disable-ico_cur
			# libraries/dependencies
			--with-libxpm=sys
			--with-libiconv=sys
			--with-regex=sys
			--with-liblzma=sys
		)
		if ${static}; then
			libtype_opts=(--enable-shared=no)
		else
			libtype_opts=(--enable-shared)
		fi
	fi
else
	# using CMake
	config_opts=(${cmake_opts[@]})

	if ${os_win}; then
		config_opts+=(
			-DwxBUILD_TOOLKIT=msw
			-DwxUSE_DBGHELP=OFF
			-DwxUSE_INICONF=OFF
			-DwxUSE_MS_HTML_HELP=OFF
			-DwxUSE_OWNER_DRAWN=OFF
			-DwxUSE_WXDIB=OFF
			# types support
			-DwxUSE_XPM=OFF
			-DwxUSE_ICO_CUR=ON
			# libraries/dependencies
			# libiconv setting???
			-DwxUSE_REGEX=builtin
		)
		libtype_opts=(
			-DwxBUILD_SHARED=ON
			-DwxBUILD_MONOLITHIC=ON
		)
		# FIXME: how to link statically to libgcc & libstdc++???
	else
		config_opts+=(
			-DwxUSE_MDI=OFF # getting linker errors on Linux/Gtk: undefined reference to `vtable for wxMDIClientWindow'
			# types support
			-DwxUSE_XPM=ON
			-DwxUSE_ICO_CUR=OFF
			# libraries/dependencies
			-DwxUSE_REGEX=sys
		)
		if ${static}; then
			libtype_opts=(-DwxBUILD_SHARED=OFF)
		else
			libtype_opts=(-DwxBUILD_SHARED=ON)
		fi
	fi
fi

#post_extract() {
#	autoreconf -fiv
#}

unset use_cmake gnu_opts cmake_opts
